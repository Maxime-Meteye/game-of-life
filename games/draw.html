<?php
header("Cache-Control: no-cache, must-revalidate");
header("Pragma: no-cache");
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox</title>
    <link rel="stylesheet" href="../style/style.css">
</head>
<body>

<?php 
    include ('../banner.html');
?>
<div id="game_div"></div>
    <canvas id="game_canvas"></canvas>
<script type="module">

const HEIGHT = 720;
const WIDTH = 1280


class Canvas{

    used_canvas;
    context;
    displayed_array = [];
    height = HEIGHT;
    width = WIDTH;
    image;
    data;
    displayed_array = [];
    constructor(hidden = false) {
        if (hidden) {
            this.used_canvas = document.createElement("canvas");
        } else {
            this.used_canvas = document.querySelector("#game_canvas");
        }

        this.used_canvas.width = this.width;
        this.used_canvas.height = this.height;
        this.context = this.used_canvas.getContext("2d");
        this.image = this.context.createImageData(WIDTH, HEIGHT);
        this.data = this.image.data;
        if (!hidden) {
            this.used_canvas.setAttribute("width", this.width);
            this.used_canvas.setAttribute("height", this.height);
        }
    }

    setBackground(color){
        this.context.fillStyle = `rgb(${color})`;
        this.context.fillRect(0, 0, this.used_canvas.width, this.used_canvas.height);
        this.context.fillStyle = `rgb(0,500,500)`;
        this.context.fillRect((this.used_canvas.width/2), 0, 1,this.used_canvas.height);
        this.context.fillRect(0, (this.used_canvas.height/2), this.used_canvas.width,1);
    }

    buildCircle(x,y,radius){
        this.context.beginPath();
        this.context.arc(x,y,radius,0,2*Math.PI);
        this.context.fill();
        this.context.stroke();
    }
    buildPixel(pixel_data){
        const i = (pixel_data.posy * this.width + pixel_data.posx) * 4;
        this.data[i] = pixel_data.r;
        this.data[i+1] = pixel_data.g;
        this.data[i+2] = pixel_data.b;
        this.data[i+3] = pixel_data.a;
        //console.log("updated data",this.data[i],this.data[i+1],this.data[i+2],this.data[i+3])
    }

    draw(display_to){
        this.displayed_array.forEach(element => {
            this.context.beginPath();
            if(element.mode == "pixel"){
                this.context.fillStyle = `rgb(${element.color})`;
                this.context.fillRect(element.posx-(element.width/2),element.posy-(element.height/2),element.width,element.height);
            }else if(element.mode == "rect"){
                this.context.fillStyle = `rgb(${element.color})`;
                this.context.fillRect(element.posx-(element.width/2),element.posy-(element.height/2),element.width,element.height);
            }
        });
    }


    render(dest_canvas){
        this.context.putImageData(this.image,0,0)
        dest_canvas.drawImage(bck_canvas.used_canvas,0,0);
    }
}

class entity{
    posx = Math.floor(Math.random()* c.used_canvas.width);
    posy = Math.floor(Math.random()* c.used_canvas.height);
    vx = 0;
    vy = 0;
    height = 1;
    width = 1;
    mode = "pixel";
    r = Math.floor(Math.random()* 250);
    g = Math.floor(Math.random()* 250);
    b = Math.floor(Math.random()* 250);
    a = 250;

    build(){
        if(this.mode == "pixel"){
            bck_canvas.buildPixel(this);
        }
    }
}

class Engine{


    game_loop(){
        init()
        //console.log(this.game_loop)
        requestAnimationFrame(()=> this.game_loop())
    }
}


let c = new Canvas();
let bck_canvas = new Canvas(true);
let engine = new Engine();


engine.game_loop();


function init(){
    c.setBackground("200,0,0");
    //let start = performance.now();
    for(let i=0; i<240000; i++) {
        let pixel = new entity;
        pixel.mode = "pixel";
        pixel.build();
    }
    bck_canvas.render(c.context);
    //let end = performance.now()
    //console.log("Made in this time:",end-start);
}


</script>
</body>
</html>